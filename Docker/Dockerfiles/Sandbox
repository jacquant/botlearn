# Pull base image
FROM python:latest

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Install dependencies
RUN pip install pipenv
RUN pip install uvicorn
RUN pip install six

RUN virtualenv /sandbox-virtualenv

# Add librairies to sanboxed python
RUN . /sandbox-virtualenv/bin/activate
RUN pip install numpy
RUN pip install -I six
RUN exit

# Add user and group sandbox
RUN apt-get update && apt-get -y install sudo
RUN addgroup sandbox
RUN adduser --disabled-login sandbox --ingroup sandbox
RUN usermod -a -G sudo sandbox

# Setup Sandbox and apparmor
COPY ./Docker/config/sandbox_sudoers /etc/sudoers.d/01-sandbox
COPY ./Docker/config/AppArmor_profile /etc/apparmor.d/sandbox-virtualenv.bin.python

RUN mkdir /api
WORKDIR /api
COPY ./code_sandbox/Pipfile* /api/

RUN pipenv install --system --deploy --ignore-pipfile
COPY ./code_sandbox/ /api/