# Pull base image
FROM python:alpine

# Install apparmor
RUN echo "@edge http://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories
RUN apk update && apk add apparmor@edge

# Install build tools
RUN apk add build-base

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Install dependencies
RUN pip install pipenv
RUN pip install uvicorn

RUN virtualenv /sandbox-virtualenv

# Add librairies to sanboxed python
RUN . /sandbox-virtualenv/bin/activate
RUN pip install numpy
RUN exit

# Add user and group sandbox
RUN addgroup sandbox
RUN adduser -D sandbox -G sandbox

# Setup Sandbox and apparmor
COPY ./Docker/config/sandbox_sudo /etc/sudoers.d/01-sandbox
COPY ./Docker/config/AppArmor_profile /etc/apparmor.d/sandbox-virtualenv.bin.python
RUN apparmor_parser /etc/apparmor.d/sandbox-virtualenv.bin.python

RUN mkdir /api
WORKDIR /api
COPY ./code_sandbox/Pipfile* /api/

RUN pipenv install --system --deploy --ignore-pipfile
COPY ./code_sandbox/ /api/