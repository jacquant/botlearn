version: "3"
services:
  nginx-frontend:
    build:
      context: ..
      dockerfile: Docker/Dockerfiles/Nginx-frontend
    container_name: nginx-frontent-memoire
    ports:
      - "8443:443"
    links:
      - api:api
    volumes:
      - ../web/static:/src/static
      - ../web/media:/src/media
    depends_on:
      - api
    networks:
      memoire-prod:
        aliases:
          - nginx-frontend
  nginx-frontend-bot:
    build:
      context: ..
      dockerfile: Docker/Dockerfiles/Nginx-frontend-bot
    container_name: nginx-frontent-bot-memoire
    ports:
      - "8444:80"
    links:
      - api:api
    depends_on:
      - api
    networks:
      memoire-prod:
        aliases:
          - nginx-frontend-bot
  cache:
    image: redis:alpine
    container_name: redis-memoire
    expose:
      - "6379"
    entrypoint: redis-server
    networks:
      memoire-prod:
        aliases:
          - redis
  celery:
    build:
      context: ..
      dockerfile: Docker/Dockerfiles/Django
    command: celery -A memoire worker -l info
    volumes:
      - ../backend/:/api
    depends_on:
      - db
      - cache
    links:
      - db:database
      - cache:redis
    env_file:
      - env/base/api.env
      - env/base/db.env
      - env/prod/api.env
      - env/prod/db.env
    networks:
      memoire-prod:
        aliases:
          - celery
  db:
    image: postgres:alpine
    container_name: postgres-memoire
    ports:
      - "5433:5432"
    env_file:
      - env/base/db.env
      - env/prod/db.env
    volumes:
      - ./postgres-data-memoire-prod:/var/lib/postgresql/data
    networks:
      memoire-prod:
        aliases:
          - database
  api:
    container_name: api-memoire
    build:
      context: ..
      dockerfile: Docker/Dockerfiles/Django
    ports:
      - "8080:8080"
    depends_on:
      - db
      - cache
    links:
      - db:database
      - cache:redis
    command: >
      sh -c "python manage.py makemigrations &&
             python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             uvicorn --host 0.0.0.0 --port 8080 memoire.asgi:application --reload"
    volumes:
      - ../backend/:/api
    env_file:
      - env/base/api.env
      - env/base/db.env
      - env/prod/api.env
      - env/prod/db.env
    networks:
      memoire-prod:
        aliases:
          - api
networks:
  memoire-prod:
    driver: bridge